<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Analytics - EMS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
    <div class="page-wrapper">
        <div id="sidebar-container"></div>

        <div class="main-content">
            <div class="card">
                <div class="card-header">
                    <div>
                        <h1>Employee Analytics</h1>
                        <p class="text-muted">View detailed performance metrics for each employee</p>
                    </div>
                    <button class="btn btn-success" onclick="exportToExcel()" id="export-btn" style="display: none;">
                        <i class="fas fa-file-excel"></i> Export to Excel
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="form-group">
                    <label class="form-label">Select Employee</label>
                    <select id="employee-select" class="form-control">
                        <option value="">Choose an employee...</option>
                    </select>
                </div>
            </div>

            <div id="analytics-section" style="display: none;">
                <div class="grid grid-4">
                    <div class="stat-card">
                        <h3 id="total-hours">0</h3>
                        <p>Total Hours (This Month)</p>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <h3 id="completed-tasks">0</h3>
                        <p>Completed Tasks</p>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                        <h3 id="pending-tasks">0</h3>
                        <p>Pending Tasks</p>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                        <h3 id="total-tasks">0</h3>
                        <p>Total Tasks</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Employee Information</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid grid-2 gap-2">
                            <div>
                                <p><strong>Name:</strong> <span id="emp-name"></span></p>
                                <p><strong>Email:</strong> <span id="emp-email"></span></p>
                                <p><strong>Username:</strong> <span id="emp-username"></span></p>
                                <p><strong>Hour Rate:</strong> <span id="emp-hour-rate"></span></p>
                            </div>
                            <div>
                                <p><strong>Type:</strong> <span id="emp-type"></span></p>
                                <p><strong>Base Salary:</strong> <span id="emp-salary"></span></p>
                                <p><strong>Monthly Factor:</strong> <span id="emp-factor"></span></p>
                                <p><strong>Overtime Price:</strong> <span id="emp-overtime-rate"></span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Monthly Stats</h3>
                        <div class="form-group" style="margin: 0; max-width: 200px;">
                            <select id="month-select" class="form-control">
                            </select>
                        </div>
                    </div>
                    <div class="card-body" id="monthly-stats">
                        <p class="text-muted">Select a month to view stats</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Task Performance History</h3>
                    </div>
                    <div class="card-body" id="task-history">
                        <p class="text-muted">Loading task history...</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Attendance Records</h3>
                    </div>
                    <div class="card-body" id="attendance-records">
                        <p class="text-muted">Loading attendance...</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Responsibilities</h3>
                    </div>
                    <div class="card-body" id="responsibilities-list">
                        <p class="text-muted">Loading responsibilities...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/components.js"></script>
    <script>
        if (!auth.init('Admin')) throw new Error('Unauthorized');
        document.getElementById('sidebar-container').innerHTML = createSidebar('Admin', 'analytics');

        let employees = [];
        let selectedEmployeeId = null;
        let employeeData = null;

        // Generate month options for the last 12 months
        function generateMonthOptions() {
            const select = document.getElementById('month-select');
            const options = [];
            const now = new Date();

            for (let i = 0; i < 12; i++) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const value = `${year}-${month}`;
                const label = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                options.push(`<option value="${value}">${label}</option>`);
            }

            select.innerHTML = options.join('');
        }

        async function loadEmployees() {
            try {
                employees = await api.getEmployees();

                const select = document.getElementById('employee-select');
                select.innerHTML = '<option value="">Choose an employee...</option>' +
                    employees.map(emp =>
                        `<option value="${emp.id}">${utils.escapeHtml(emp.name)}</option>`
                    ).join('');
            } catch (error) {
                showToast('Failed to load employees: ' + error.message, 'error');
            }
        }

        document.getElementById('employee-select').addEventListener('change', async (e) => {
            selectedEmployeeId = e.target.value;

            if (!selectedEmployeeId) {
                document.getElementById('analytics-section').style.display = 'none';
                document.getElementById('export-btn').style.display = 'none';
                return;
            }

            document.getElementById('analytics-section').style.display = 'block';
            document.getElementById('export-btn').style.display = 'inline-flex';
            await loadEmployeeAnalytics();
        });

        document.getElementById('month-select').addEventListener('change', loadMonthlyStats);

        async function loadEmployeeAnalytics() {
            if (!selectedEmployeeId) return;

            try {
                showLoading();

                employeeData = await api.getEmployee(selectedEmployeeId);

                // Update employee info
                document.getElementById('emp-name').textContent = employeeData.name;
                document.getElementById('emp-email').textContent = employeeData.email || '-';
                document.getElementById('emp-username').textContent = employeeData.username || '-';
                document.getElementById('emp-type').textContent = employeeData.employeeType;
                document.getElementById('emp-salary').textContent = utils.formatCurrency(employeeData.baseSalary);
                document.getElementById('emp-factor').textContent = employeeData.monthlyFactor;
                document.getElementById('emp-hour-rate').textContent = utils.formatCurrency(employeeData.normalHourRate || 10);
                document.getElementById('emp-overtime-rate').textContent = utils.formatCurrency(employeeData.overtimeHourRate || 15);

                // Calculate task stats
                const tasks = employeeData.assignedTasks || [];
                const completedTasks = tasks.filter(t => t.status === 'Done').length;
                const pendingTasks = tasks.filter(t => t.status === 'Pending').length;

                document.getElementById('completed-tasks').textContent = completedTasks;
                document.getElementById('pending-tasks').textContent = pendingTasks;
                document.getElementById('total-tasks').textContent = tasks.length;

                // Calculate total hours for current month
                const currentMonth = utils.getCurrentMonth();
                const attendance = employeeData.attendanceRecords || [];
                const monthAttendance = attendance.filter(a => a.date && a.date.startsWith(currentMonth));
                const totalHours = monthAttendance.reduce((sum, a) => sum + (a.totalHours || 0), 0);
                document.getElementById('total-hours').textContent = totalHours.toFixed(1);

                // Load task history
                renderTaskHistory(tasks);

                // Load attendance records
                renderAttendanceRecords(attendance);

                // Load responsibilities
                renderResponsibilities(employeeData.assignedResponsibilities || []);

                // Load monthly stats for current month
                await loadMonthlyStats();

                hideLoading();
            } catch (error) {
                hideLoading();
                showToast('Failed to load analytics: ' + error.message, 'error');
            }
        }

        async function loadMonthlyStats() {
            if (!selectedEmployeeId) return;
            const month = document.getElementById('month-select').value;
            const container = document.getElementById('monthly-stats');

            try {
                container.innerHTML = '<p class="text-muted">Loading stats...</p>';
                const stats = await api.getMonthlyTotal(selectedEmployeeId, { month });
                
                container.innerHTML = `
                    <div class="grid grid-4">
                        <div style="text-align: center;">
                            <h3>${stats.totalSessions || 0}</h3>
                            <p class="text-muted">Sessions</p>
                        </div>
                        <div style="text-align: center;">
                            <h3>${stats.daysWorked || 0}</h3>
                            <p class="text-muted">Days</p>
                        </div>
                        <div style="text-align: center;">
                            <h3>${(stats.totalHours || 0).toFixed(1)}</h3>
                            <p class="text-muted">Hours</p>
                        </div>
                        <div style="text-align: center;">
                            <h3>${stats.avgHoursPerDay || 0}</h3>
                            <p class="text-muted">Avg/Day</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                container.innerHTML = `<p class="text-danger">Failed to load stats: ${error.message}</p>`;
            }
        }

        function renderTaskHistory(tasks) {
            const container = document.getElementById('task-history');

            if (tasks.length === 0) {
                container.innerHTML = '<p class="text-muted">No tasks assigned</p>';
                return;
            }

            const rows = tasks.map(task => ({
                data: [
                    utils.escapeHtml(task.title || task.name || task.templateName || '-'),
                    `<span class="badge ${utils.getStatusBadgeClass(task.status)}">${task.status}</span>`,
                    utils.formatCurrency(task.price || task.templatePrice || 0),
                    utils.formatDateReadable(task.createdAt)
                ]
            }));

            container.innerHTML = createTable(
                ['Task', 'Status', 'Price', 'Created'],
                rows
            );
        }

        function renderAttendanceRecords(records) {
            const container = document.getElementById('attendance-records');

            if (records.length === 0) {
                container.innerHTML = '<p class="text-muted">No attendance records</p>';
                return;
            }

            const rows = records.slice(0, 10).map(record => ({
                data: [
                    utils.formatDateReadable(record.date),
                    utils.formatTime(record.checkIn),
                    utils.formatTime(record.checkOut) || '-',
                    record.totalHours ? record.totalHours.toFixed(2) : '-'
                ]
            }));

            container.innerHTML = createTable(
                ['Date', 'Check In', 'Check Out', 'Total Hours'],
                rows
            );
        }

        function renderResponsibilities(responsibilities) {
            const container = document.getElementById('responsibilities-list');

            if (responsibilities.length === 0) {
                container.innerHTML = '<p class="text-muted">No responsibilities assigned</p>';
                return;
            }

            const rows = responsibilities.map(resp => ({
                data: [
                    utils.escapeHtml(resp.title),
                    utils.escapeHtml(resp.description || '-'),
                    utils.formatCurrency(resp.monthlyPrice),
                    resp.factor
                ]
            }));

            container.innerHTML = createTable(
                ['Title', 'Description', 'Monthly Price', 'Factor'],
                rows
            );
        }

        async function exportToExcel() {
            if (!selectedEmployeeId || !employeeData) {
                showToast('Please select an employee first', 'error');
                return;
            }

            try {
                showLoading();
                const month = document.getElementById('month-select').value;
                const monthLabel = document.getElementById('month-select').selectedOptions[0].text;
                
                // Create a new workbook
                const wb = XLSX.utils.book_new();

                // Sheet 1: Employee Information
                const employeeInfo = [
                    ['Employee Information', ''],
                    ['Name', employeeData.name],
                    ['Email', employeeData.email || '-'],
                    ['Username', employeeData.username || '-'],
                    ['Type', employeeData.employeeType],
                    ['Base Salary', employeeData.baseSalary],
                    ['Monthly Factor', employeeData.monthlyFactor],
                    ['Normal Hour Rate', employeeData.normalHourRate || 0],
                    ['Overtime Hour Rate', employeeData.overtimeHourRate || 0],
                    [''],
                    ['Report Generated', new Date().toLocaleString()],
                    ['Month', monthLabel]
                ];
                const ws1 = XLSX.utils.aoa_to_sheet(employeeInfo);
                ws1['!cols'] = [{ wch: 20 }, { wch: 30 }];
                XLSX.utils.book_append_sheet(wb, ws1, 'Employee Info');

                // Sheet 2: Monthly Summary
                const stats = await api.getMonthlyTotal(selectedEmployeeId, { month });
                const monthlySummary = [
                    ['Monthly Summary - ' + monthLabel, ''],
                    [''],
                    ['Metric', 'Value'],
                    ['Total Sessions', stats.totalSessions || 0],
                    ['Days Worked', stats.daysWorked || 0],
                    ['Total Hours', (stats.totalHours || 0).toFixed(2)],
                    ['Average Hours/Day', stats.avgHoursPerDay || 0],
                    [''],
                    ['Task Statistics', ''],
                    ['Total Tasks', employeeData.assignedTasks?.length || 0],
                    ['Completed Tasks', employeeData.assignedTasks?.filter(t => t.status === 'Done').length || 0],
                    ['Pending Tasks', employeeData.assignedTasks?.filter(t => t.status === 'Pending').length || 0]
                ];
                const ws2 = XLSX.utils.aoa_to_sheet(monthlySummary);
                ws2['!cols'] = [{ wch: 25 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, ws2, 'Monthly Summary');

                // Sheet 3: Attendance Records
                const attendance = employeeData.attendanceRecords || [];
                const monthAttendance = attendance.filter(a => a.date && a.date.startsWith(month));
                const attendanceData = [
                    ['Attendance Records - ' + monthLabel],
                    [''],
                    ['Date', 'Check In', 'Check Out', 'Total Hours', 'Day of Week']
                ];
                monthAttendance.forEach(record => {
                    const date = new Date(record.date);
                    attendanceData.push([
                        utils.formatDateReadable(record.date),
                        utils.formatTime(record.checkIn) || '-',
                        utils.formatTime(record.checkOut) || '-',
                        record.totalHours ? record.totalHours.toFixed(2) : '-',
                        date.toLocaleDateString('en-US', { weekday: 'long' })
                    ]);
                });
                const ws3 = XLSX.utils.aoa_to_sheet(attendanceData);
                ws3['!cols'] = [{ wch: 15 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, ws3, 'Attendance');

                // Sheet 4: Tasks
                const tasks = employeeData.assignedTasks || [];
                const monthTasks = tasks.filter(t => {
                    // Include tasks due this month or completed this month
                    const isDueThisMonth = t.dueDate && t.dueDate.startsWith(month);
                    const isCompletedThisMonth = t.completedAt && t.completedAt.startsWith(month);
                    return isDueThisMonth || isCompletedThisMonth;
                });
                
                const tasksData = [
                    ['Task Assignments - ' + monthLabel],
                    [''],
                    ['Task Name', 'Status', 'Assigned Date', 'Due Date', 'Completed Date', 'Price', 'Factor', 'Total Earnings']
                ];
                monthTasks.forEach(task => {
                    const price = task.price || task.templatePrice || 0;
                    const factor = task.factor || task.templateFactor || 1;
                    const earnings = price * factor;
                    tasksData.push([
                        task.title || task.name || task.templateName || '-',
                        task.status,
                        utils.formatDateReadable(task.createdAt),
                        task.dueDate ? utils.formatDateReadable(task.dueDate) : '-',
                        task.completedAt ? utils.formatDateReadable(task.completedAt) : '-',
                        price.toFixed(2),
                        factor,
                        earnings.toFixed(2) + ' EGP'
                    ]);
                });
                
                // Add summary row
                tasksData.push(['']);
                tasksData.push(['SUMMARY', '', '', '', '', '', '', '']);
                tasksData.push(['Total Tasks', monthTasks.length, '', '', '', '', '', '']);
                tasksData.push(['Completed', monthTasks.filter(t => t.status === 'Done').length, '', '', '', '', '', '']);
                tasksData.push(['Pending', monthTasks.filter(t => t.status === 'Pending' || t.status === 'In Progress').length, '', '', '', '', '', '']);
                
                const ws4 = XLSX.utils.aoa_to_sheet(tasksData);
                ws4['!cols'] = [{ wch: 30 }, { wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 10 }, { wch: 8 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, ws4, 'Tasks');

                // Sheet 5: Responsibilities
                const responsibilities = employeeData.assignedResponsibilities || [];
                const respData = [
                    ['Responsibilities'],
                    [''],
                    ['Title', 'Description', 'Monthly Price', 'Factor', 'Total', 'Status']
                ];
                responsibilities.forEach(resp => {
                    const total = (resp.monthlyPrice || 0) * (resp.factor || 1);
                    respData.push([
                        resp.title,
                        resp.description || '-',
                        resp.monthlyPrice || 0,
                        resp.factor || 1,
                        total.toFixed(2),
                        resp.status || 'Active'
                    ]);
                });
                const ws5 = XLSX.utils.aoa_to_sheet(respData);
                ws5['!cols'] = [{ wch: 25 }, { wch: 40 }, { wch: 15 }, { wch: 10 }, { wch: 12 }, { wch: 12 }];
                XLSX.utils.book_append_sheet(wb, ws5, 'Responsibilities');

                // Sheet 6: Salary Calculation
                const normalRate = employeeData.normalHourRate || 0;
                const overtimeRate = employeeData.overtimeHourRate || 0;
                const requiredHours = employeeData.requiredMonthlyHours || 160;
                const totalHours = (stats.totalHours || 0);
                const normalHours = Math.min(totalHours, requiredHours);
                const overtimeHours = Math.max(0, totalHours - requiredHours);
                
                // Calculate earnings
                const hoursEarnings = (normalHours * normalRate) + (overtimeHours * overtimeRate);
                const taskEarnings = tasks
                    .filter(t => t.status === 'Done' && t.completedAt && t.completedAt.startsWith(month))
                    .reduce((sum, t) => sum + ((t.price || t.templatePrice || 0) * (t.factor || t.templateFactor || 1)), 0);
                const respEarnings = responsibilities
                    .filter(r => r.status === 'Active')
                    .reduce((sum, r) => sum + ((r.monthlyPrice || 0) * (r.factor || 1)), 0);
                const totalEarnings = employeeData.baseSalary + hoursEarnings + taskEarnings + respEarnings;

                const salaryData = [
                    ['Salary Calculation - ' + monthLabel, ''],
                    [''],
                    ['HOURS WORKED', ''],
                    ['Total Hours', totalHours.toFixed(2)],
                    ['Normal Hours (0-' + requiredHours + ')', normalHours.toFixed(2)],
                    ['Overtime Hours', overtimeHours.toFixed(2)],
                    ['Normal Rate', normalRate.toFixed(2) + ' EGP/hour'],
                    ['Overtime Rate', overtimeRate.toFixed(2) + ' EGP/hour'],
                    ['Hours Earnings', hoursEarnings.toFixed(2) + ' EGP'],
                    [''],
                    ['TASKS COMPLETED THIS MONTH', ''],
                    ['Tasks Done', tasks.filter(t => t.status === 'Done' && t.completedAt && t.completedAt.startsWith(month)).length],
                    ['Task Earnings', taskEarnings.toFixed(2) + ' EGP'],
                    [''],
                    ['RESPONSIBILITIES', ''],
                    ['Active Responsibilities', responsibilities.filter(r => r.status === 'Active').length],
                    ['Responsibility Earnings', respEarnings.toFixed(2) + ' EGP'],
                    [''],
                    ['TOTAL SALARY', ''],
                    ['Base Salary', employeeData.baseSalary.toFixed(2) + ' EGP'],
                    ['Hours Earnings', hoursEarnings.toFixed(2) + ' EGP'],
                    ['Task Earnings', taskEarnings.toFixed(2) + ' EGP'],
                    ['Responsibility Earnings', respEarnings.toFixed(2) + ' EGP'],
                    [''],
                    ['TOTAL MONTHLY SALARY', totalEarnings.toFixed(2) + ' EGP']
                ];
                const ws6 = XLSX.utils.aoa_to_sheet(salaryData);
                ws6['!cols'] = [{ wch: 30 }, { wch: 20 }];
                
                // Style the total row (make it bold by setting font)
                ws6['A25'] = { v: 'TOTAL MONTHLY SALARY', t: 's', s: { font: { bold: true } } };
                ws6['B25'] = { v: totalEarnings.toFixed(2) + ' EGP', t: 's', s: { font: { bold: true } } };
                
                XLSX.utils.book_append_sheet(wb, ws6, 'Salary Calculation');

                // Sheet 7: Deductions
                const deductions = employeeData.deductions || [];
                const monthDeductions = deductions.filter(d => d.month === month);
                const deductionsData = [
                    ['Deductions - ' + monthLabel],
                    [''],
                    ['Date', 'Reason', 'Amount', 'Type', 'Notes']
                ];
                
                let totalDeductions = 0;
                monthDeductions.forEach(deduction => {
                    const amount = deduction.amount || 0;
                    totalDeductions += amount;
                    deductionsData.push([
                        utils.formatDateReadable(deduction.createdAt || deduction.date),
                        deduction.reason || '-',
                        amount.toFixed(2) + ' EGP',
                        deduction.type || 'Deduction',
                        deduction.notes || '-'
                    ]);
                });
                
                // Add summary
                deductionsData.push(['']);
                deductionsData.push(['TOTAL DEDUCTIONS', '', totalDeductions.toFixed(2) + ' EGP', '', '']);
                deductionsData.push(['']);
                deductionsData.push(['NET SALARY', '', (totalEarnings - totalDeductions).toFixed(2) + ' EGP', '', '']);
                
                const ws7 = XLSX.utils.aoa_to_sheet(deductionsData);
                ws7['!cols'] = [{ wch: 15 }, { wch: 30 }, { wch: 15 }, { wch: 15 }, { wch: 40 }];
                XLSX.utils.book_append_sheet(wb, ws7, 'Deductions');

                // Generate filename
                const filename = `${employeeData.name.replace(/\s+/g, '_')}_${month}_Report.xlsx`;

                // Write file
                XLSX.writeFile(wb, filename);

                hideLoading();
                showToast('Excel file downloaded successfully!', 'success');
            } catch (error) {
                hideLoading();
                showToast('Failed to export: ' + error.message, 'error');
            }
        }

        generateMonthOptions();
        loadEmployees();
    </script>
</body>

</html>
