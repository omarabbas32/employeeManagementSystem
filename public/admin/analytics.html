<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Analytics - EMS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
    <div class="page-wrapper">
        <div id="sidebar-container"></div>

        <div class="main-content">
            <div class="card">
                <div class="card-header">
                    <div>
                        <h1>Employee Analytics</h1>
                        <p class="text-muted">View detailed performance metrics for each employee</p>
                    </div>
                    <button class="btn btn-success" onclick="exportToExcel()" id="export-btn" style="display: none;">
                        <i class="fas fa-file-excel"></i> Export to Excel
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="grid grid-2 gap-1">
                    <div class="form-group">
                        <label class="form-label">Select Employee</label>
                        <select id="employee-select" class="form-control">
                            <option value="">Choose an employee...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Filter by Date Range</label>
                        <div class="grid grid-2 gap-1">
                            <input type="date" id="date-from" class="form-control" placeholder="From">
                            <input type="date" id="date-to" class="form-control" placeholder="To">
                        </div>
                    </div>
                </div>
            </div>

            <div id="analytics-section" style="display: none;">
                <div class="grid grid-4">
                    <div class="stat-card">
                        <h3 id="total-hours">0</h3>
                        <p>Total Hours (This Month)</p>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <h3 id="completed-tasks">0</h3>
                        <p>Completed Tasks</p>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                        <h3 id="pending-tasks">0</h3>
                        <p>Pending Tasks</p>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                        <h3 id="total-tasks">0</h3>
                        <p>Total Tasks</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Employee Information</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid grid-2 gap-2">
                            <div>
                                <p><strong>Name:</strong> <span id="emp-name"></span></p>
                                <p><strong>Email:</strong> <span id="emp-email"></span></p>
                                <p><strong>Username:</strong> <span id="emp-username"></span></p>
                                <p><strong>Hour Rate:</strong> <span id="emp-hour-rate"></span></p>
                            </div>
                            <div>
                                <p><strong>Type:</strong> <span id="emp-type"></span></p>
                                <p><strong>Base Salary:</strong> <span id="emp-salary"></span></p>
                                <p><strong>Monthly Factor:</strong> <span id="emp-factor"></span></p>
                                <p><strong>Overtime Price:</strong> <span id="emp-overtime-rate"></span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Monthly Stats</h3>
                        <div class="form-group" style="margin: 0; max-width: 200px;">
                            <select id="month-select" class="form-control">
                            </select>
                        </div>
                    </div>
                    <div class="card-body" id="monthly-stats">
                        <p class="text-muted">Select a month to view stats</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Task Performance History</h3>
                    </div>
                    <div class="card-body" id="task-history">
                        <p class="text-muted">Loading task history...</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Attendance Records</h3>
                    </div>
                    <div class="card-body" id="attendance-records">
                        <p class="text-muted">Loading attendance...</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Responsibilities</h3>
                    </div>
                    <div class="card-body" id="responsibilities-list">
                        <p class="text-muted">Loading responsibilities...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/components.js"></script>
    <script>
        if (!auth.init('Admin')) throw new Error('Unauthorized');
        document.getElementById('sidebar-container').innerHTML = createSidebar('Admin', 'analytics');

        let employees = [];
        let selectedEmployeeId = null;
        let employeeData = null;

        // Generate month options for the last 12 months
        function generateMonthOptions() {
            const select = document.getElementById('month-select');
            const options = [];
            const now = new Date();

            for (let i = 0; i < 12; i++) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const value = `${year}-${month}`;
                const label = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                options.push(`<option value="${value}">${label}</option>`);
            }

            select.innerHTML = options.join('');
        }

        async function loadEmployees() {
            try {
                employees = await api.getEmployees();

                const select = document.getElementById('employee-select');
                select.innerHTML = '<option value="">Choose an employee...</option>' +
                    employees.map(emp =>
                        `<option value="${emp.id}">${utils.escapeHtml(emp.name)}</option>`
                    ).join('');
            } catch (error) {
                showToast('Failed to load employees: ' + error.message, 'error');
            }
        }

        document.getElementById('employee-select').addEventListener('change', async (e) => {
            selectedEmployeeId = e.target.value;

            if (!selectedEmployeeId) {
                document.getElementById('analytics-section').style.display = 'none';
                document.getElementById('export-btn').style.display = 'none';
                return;
            }

            document.getElementById('analytics-section').style.display = 'block';
            document.getElementById('export-btn').style.display = 'inline-flex';
            await loadEmployeeAnalytics();
        });

        document.getElementById('month-select').addEventListener('change', loadMonthlyStats);

        async function loadEmployeeAnalytics() {
            if (!selectedEmployeeId) return;

            try {
                showLoading();

                employeeData = await api.getEmployee(selectedEmployeeId);

                // Update employee info
                document.getElementById('emp-name').textContent = employeeData.name;
                document.getElementById('emp-email').textContent = employeeData.email || '-';
                document.getElementById('emp-username').textContent = employeeData.username || '-';
                document.getElementById('emp-type').textContent = employeeData.employeeType;
                document.getElementById('emp-salary').textContent = utils.formatCurrency(employeeData.baseSalary);
                document.getElementById('emp-factor').textContent = employeeData.monthlyFactor;
                document.getElementById('emp-hour-rate').textContent = utils.formatCurrency(employeeData.normalHourRate || 10);
                document.getElementById('emp-overtime-rate').textContent = utils.formatCurrency(employeeData.overtimeHourRate || 15);

                // Calculate task stats
                const tasks = employeeData.assignedTasks || [];
                const completedTasks = tasks.filter(t => t.status === 'Done').length;
                const pendingTasks = tasks.filter(t => t.status === 'Pending').length;

                document.getElementById('completed-tasks').textContent = completedTasks;
                document.getElementById('pending-tasks').textContent = pendingTasks;
                document.getElementById('total-tasks').textContent = tasks.length;

                // Calculate total hours for current month
                const currentMonth = utils.getCurrentMonth();
                const attendance = employeeData.attendanceRecords || [];
                const monthAttendance = attendance.filter(a => a.date && a.date.startsWith(currentMonth));
                const totalHours = monthAttendance.reduce((sum, a) => sum + (a.totalHours || 0), 0);
                document.getElementById('total-hours').textContent = totalHours.toFixed(1);

                // Load task history
                renderTaskHistory(tasks);

                // Load attendance records
                renderAttendanceRecords(attendance);

                // Load responsibilities
                renderResponsibilities(employeeData.assignedResponsibilities || []);

                // Load monthly stats for current month
                await loadMonthlyStats();

                hideLoading();
            } catch (error) {
                hideLoading();
                showToast('Failed to load analytics: ' + error.message, 'error');
            }
        }

        async function loadMonthlyStats() {
            if (!selectedEmployeeId) return;
            const month = document.getElementById('month-select').value;
            const container = document.getElementById('monthly-stats');

            try {
                container.innerHTML = '<p class="text-muted">Loading stats...</p>';
                const stats = await api.getMonthlyTotal(selectedEmployeeId, { month });

                container.innerHTML = `
                    <div class="grid grid-4">
                        <div style="text-align: center;">
                            <h3>${stats.totalSessions || 0}</h3>
                            <p class="text-muted">Sessions</p>
                        </div>
                        <div style="text-align: center;">
                            <h3>${stats.daysWorked || 0}</h3>
                            <p class="text-muted">Days</p>
                        </div>
                        <div style="text-align: center;">
                            <h3>${(stats.totalHours || 0).toFixed(1)}</h3>
                            <p class="text-muted">Hours</p>
                        </div>
                        <div style="text-align: center;">
                            <h3>${stats.avgHoursPerDay || 0}</h3>
                            <p class="text-muted">Avg/Day</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                container.innerHTML = `<p class="text-danger">Failed to load stats: ${error.message}</p>`;
            }
        }

        function renderTaskHistory(tasks) {
            const container = document.getElementById('task-history');
            const filteredTasks = filterByDateRange(tasks, 'createdAt');

            if (filteredTasks.length === 0) {
                container.innerHTML = '<p class="text-muted">No tasks found for selected date range</p>';
                return;
            }

            const rows = filteredTasks.map(task => ({
                data: [
                    utils.escapeHtml(task.title || task.name || task.templateName || '-'),
                    `<span class="badge ${utils.getStatusBadgeClass(task.status)}">${task.status}</span>`,
                    utils.formatCurrency(task.price || task.templatePrice || 0),
                    utils.formatDateReadable(task.createdAt)
                ]
            }));

            container.innerHTML = createTable(
                ['Task', 'Status', 'Price', 'Created'],
                rows
            );
        }

        function renderAttendanceRecords(records) {
            const container = document.getElementById('attendance-records');
            const filteredRecords = filterByDateRange(records, 'date');

            if (filteredRecords.length === 0) {
                container.innerHTML = '<p class="text-muted">No attendance records for selected date range</p>';
                return;
            }

            const rows = filteredRecords.slice(0, 50).map(record => ({
                data: [
                    utils.formatDateReadable(record.date),
                    utils.formatTime(record.checkIn),
                    utils.formatTime(record.checkOut) || '-',
                    record.totalHours ? record.totalHours.toFixed(2) : '-'
                ]
            }));

            container.innerHTML = createTable(
                ['Date', 'Check In', 'Check Out', 'Total Hours'],
                rows
            );
        }

        function renderResponsibilities(responsibilities) {
            const container = document.getElementById('responsibilities-list');

            if (responsibilities.length === 0) {
                container.innerHTML = '<p class="text-muted">No responsibilities assigned</p>';
                return;
            }

            const rows = responsibilities.map(resp => ({
                data: [
                    utils.escapeHtml(resp.title),
                    utils.escapeHtml(resp.description || '-'),
                    utils.formatCurrency(resp.monthlyPrice),
                    resp.factor
                ]
            }));

            container.innerHTML = createTable(
                ['Title', 'Description', 'Monthly Price', 'Factor'],
                rows
            );
        }

async function exportToExcel() {
    if (!selectedEmployeeId || !employeeData) {
        showToast('Please select an employee first', 'error');
        return;
    }

    try {
        showLoading();
        const month = document.getElementById('month-select').value;
        const monthLabel = document.getElementById('month-select').selectedOptions[0].text;

        const wb = XLSX.utils.book_new();
        const data = [];

        // 1. Employee Information
        data.push(['Employee Information', '']);
        data.push(['Name', employeeData.name]);
        data.push(['Email', employeeData.email || '-']);
        data.push(['Username', employeeData.username || '-']);
        data.push(['Type', employeeData.employeeType]);
        data.push(['Base Salary', employeeData.baseSalary]);
        data.push(['Monthly Factor', employeeData.monthlyFactor]);
        data.push(['Normal Hour Rate', employeeData.normalHourRate || 0]);
        data.push(['Overtime Hour Rate', employeeData.overtimeHourRate || 0]);
        data.push([]);
        data.push(['Report Generated', new Date().toLocaleString()]);
        data.push(['Month', monthLabel]);
        data.push([]);
        
        // 2. Task Performance History
        const tasks = employeeData.assignedTasks || [];
        data.push(['Task Performance History']);
        data.push(['Task Name', 'Status', 'Price', 'Created Date']);
        tasks.forEach(task => {
            const price = task.price || task.templatePrice || 0;
            data.push([
                task.title || task.name || task.templateName || '-',
                task.status || '-',
                price.toFixed(2),
                task.createdAt ? utils.formatDateReadable(task.createdAt) : '-'
            ]);
        });
        data.push([]);

        // 3. Attendance Records
        const attendance = employeeData.attendanceRecords || [];
        data.push(['Attendance Records']);
        data.push(['Date', 'Check-in', 'Check-out', 'Total Hours']);
        attendance.forEach(record => {
            data.push([
                utils.formatDateReadable(record.date),
                utils.formatTime(record.checkIn) || '-',
                utils.formatTime(record.checkOut) || '-',
                record.totalHours ? record.totalHours.toFixed(2) : '-'
            ]);
        });
        data.push([]);

        // 4. Responsibilities
        const responsibilities = employeeData.assignedResponsibilities || [];
        data.push(['Responsibilities']);
        data.push(['Title', 'Description', 'Monthly Price', 'Factor']);
        responsibilities.forEach(resp => {
            data.push([
                resp.title || '-',
                resp.description || '-',
                resp.monthlyPrice ? resp.monthlyPrice.toFixed(2) : '0',
                resp.factor || '-'
            ]);
        });

        const ws = XLSX.utils.aoa_to_sheet(data);
        ws['!cols'] = [{ wch: 25 }, { wch: 20 }, { wch: 15 }, { wch: 15 }];
        XLSX.utils.book_append_sheet(wb, ws, 'Employee Report');

        const filename = `${employeeData.name.replace(/\s+/g, '_')}_${month}_Report.xlsx`;
        XLSX.writeFile(wb, filename);

        hideLoading();
        showToast('Excel file downloaded successfully!', 'success');
    } catch (error) {
        hideLoading();
        showToast('Failed to export: ' + error.message, 'error');
    }
}

        // Date filtering function
        function filterByDateRange(items, dateField) {
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;

            if (!dateFrom && !dateTo) {
                return items;
            }

            return items.filter(item => {
                if (!item[dateField]) return false;
                const itemDate = item[dateField].split('T')[0]; // Get YYYY-MM-DD part
                
                if (dateFrom && itemDate < dateFrom) return false;
                if (dateTo && itemDate > dateTo) return false;
                return true;
            });
        }

        // Add event listeners for date filters
        document.getElementById('date-from').addEventListener('change', () => {
            if (selectedEmployeeId) {
                loadEmployeeAnalytics();
            }
        });

        document.getElementById('date-to').addEventListener('change', () => {
            if (selectedEmployeeId) {
                loadEmployeeAnalytics();
            }
        });

        generateMonthOptions();
        loadEmployees();
    </script>
</body>

</html>