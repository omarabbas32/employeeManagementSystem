<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فاتورة الموظف</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lalezar&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Lalezar", sans-serif;

        }

        body {
            background-image: url(admin/assets/5.jpg);
            font-size: 12px;
            line-height: 1.3;
            color: #000;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            background-attachment: fixed;
            height: auto;
            box-sizing: border-box;
        }

        .invoice-container {
            width: 80mm;
            max-width: 302px;
            margin: 0 auto;
            padding: 10px;
            background: transparent;
            direction: rtl;
        }

        /* Header Section */
        .invoice-header {
            text-align: center;
            border-bottom: 2px dashed #000;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .invoice-title {
            font-size: 14px;
            font-weight: 600;
        }

        /* Employee Info */
        .employee-info {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 11px;
        }

        .info-label {
            font-weight: 600;
        }

        .info-value {
            text-align: left;
        }

        /* Section Headers */
        .section-header {
            background: #000;
            color: #fff;
            padding: 5px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            margin: 10px 0 5px 0;
        }

        /* Data Rows */
        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 11px;
            border-bottom: 1px dotted #ddd;
        }

        .data-label {
            font-weight: 500;
        }

        .data-value {
            font-weight: 600;
            text-align: left;
        }

        /* Totals Section */
        .totals-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px dashed #000;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 13px;
            direction: rtl;
        }

        .total-row.final {
            font-size: 15px;
            font-weight: bold;
            margin-top: 5px;
            padding-top: 8px;
            border-top: 2px solid #000;
        }

        /* Footer */
        .invoice-footer {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 2px dashed #000;
            text-align: center;
            font-size: 10px;
        }

        /* Print Styles */
        @media print {
            body {
                margin: 0;
                padding: 0;
            }

            .invoice-container {
                width: 80mm;
                max-width: 80mm;
                margin: 0;
                padding: 5mm;
            }

            .no-print {
                display: none !important;
            }
        }

        /* Print Button */
        .print-button {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 12px 24px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-family: "Lalezar", sans-serif;
        }

        .print-button:hover {
            background: #1d4ed8;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 14px;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #dc2626;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <button class="print-button no-print" onclick="window.print()"><i class="fas fa-print"></i> طباعة الفاتورة</button>

    <div id="loading" class="loading">
        جاري تحميل بيانات الفاتورة...
    </div>

    <div id="error" class="error" style="display: none;">
        فشل تحميل بيانات الفاتورة. يرجى المحاولة مرة أخرى.
    </div>

    <div id="invoice" class="invoice-container" style="display: none;">
        <!-- Header -->
        <div class="invoice-header">
            <div class="invoice-title">فاتورة الرواتب</div>
        </div>

        <!-- Employee Information -->
        <div class="employee-info">
            <div class="info-row">
                <span class="info-label">الموظف:</span>
                <span class="info-value" id="employee-name">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">الرقم:</span>
                <span class="info-value" id="employee-id">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">التاريخ:</span>
                <span class="info-value" id="invoice-date">-</span>
            </div>
        </div>

        <!-- Working Hours -->
        <div class="section-header">ساعات العمل</div>
        <div class="data-row">
            <span class="data-label">الساعات العادية:</span>
            <span class="data-value" id="regular-hours">0 ساعة</span>
        </div>
        <div class="data-row">
            <span class="data-label">ساعات إضافية:</span>
            <span class="data-value" id="overtime-hours">0 ساعة</span>
        </div>
        <div class="data-row">
            <span class="data-label">إجمالي الساعات:</span>
            <span class="data-value" id="total-hours">0 ساعة</span>
        </div>

        <!-- Tasks Count (NOT list) -->
        <div class="section-header">المهام</div>
        <div id="tasks-list">
            <div class="data-row">
                <span class="data-label">لا توجد مهام</span>
            </div>
        </div>

        <!-- Responsibilities Count (NOT list) -->
        <div class="section-header">المسؤوليات</div>
        <div id="responsibilities-list">
            <div class="data-row">
                <span class="data-label">لا توجد مسؤوليات</span>
            </div>
        </div>

        <!-- Deductions Count (NOT list) -->
        <div class="section-header">الخصومات</div>
        <div id="deductions-list">
            <div class="data-row">
                <span class="data-label">لا توجد خصومات</span>
            </div>
        </div>

        <!-- Totals (ONLY Net Salary) -->
        <div class="totals-section">
            <div class="total-row final">
                <span>صافي الراتب:</span>
                <span id="net-salary">0 جنيه</span>
            </div>
        </div>

        <!-- Footer -->
        <div class="invoice-footer">
            <div>شكراً لعملك الجاد!</div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const employeeId = urlParams.get('employeeId');
        const month = urlParams.get('month');

        const arabicMonths = [
            'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
            'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
        ];

        // Format currency in Egyptian Pounds (جنيه) - NO DECIMALS
        function formatCurrency(amount) {
            const formatted = new Intl.NumberFormat('ar-EG', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(Math.round(amount || 0));
            return `${formatted} جنيه`;
        }

        function formatDate(dateString) {
            if (!dateString) {
                const now = new Date();
                return `${arabicMonths[now.getMonth()]} ${now.getFullYear()}`;
            }
            const date = new Date(dateString + '-01');
            return `${arabicMonths[date.getMonth()]} ${date.getFullYear()}`;
        }

        function formatArabicDate() {
            const now = new Date();
            const day = now.getDate();
            const month = arabicMonths[now.getMonth()];
            const year = now.getFullYear();
            return `${day} ${month} ${year}`;
        }

        function validateInvoiceData(employee, salaryData, tasks, deductions, responsibilities) {
            const errors = [];
            if (!employee || !employee.name || !employee.id) errors.push('بيانات الموظف غير مكتملة');
            if (!salaryData) errors.push('بيانات الراتب مفقودة');
            else {
                if (salaryData.netSalary === undefined || salaryData.netSalary === null) errors.push('صافي الراتب غير محدد');
            }
            if (!Array.isArray(tasks)) errors.push('بيانات المهام غير صحيحة');
            if (!Array.isArray(deductions)) errors.push('بيانات الخصومات غير صحيحة');
            if (!Array.isArray(responsibilities)) errors.push('بيانات المسؤوليات غير صحيحة');
            return errors;
        }

        async function loadInvoiceData() {
            if (!employeeId || !month) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'معرف الموظف أو الشهر مفقود';
                return;
            }

            try {
                const [salaryData, employee, allTasks, allDeductions, allResponsibilities] = await Promise.all([
                    api.getSalary(employeeId, { month: month }),
                    api.getEmployee(employeeId),
                    api.getTaskAssignments({ employeeId: employeeId }),
                    api.getEmployeeDeductions(employeeId),
                    api.getResponsibilities()
                ]);

                // Filter tasks for current month only
                const completedTasks = allTasks.filter(t => {
                    if (t.status !== 'Completed' && t.status !== 'Done') return false;
                    if (t.completedAt) return t.completedAt.startsWith(month);
                    if (t.updatedAt && (t.status === 'Completed' || t.status === 'Done')) return t.updatedAt.startsWith(month);
                    return false;
                });

                // Filter deductions for current month
                let monthDeductions = [];
                if (salaryData.deductions && salaryData.deductions.details) {
                    monthDeductions = salaryData.deductions.details;
                } else if (allDeductions) {
                    monthDeductions = allDeductions.filter(d => !d.month || d.month === month);
                }

                // Filter responsibilities for current month
                const employeeResponsibilities = allResponsibilities.filter(r => {
                    if (r.assignedEmployeeId != employeeId) return false;
                    if (r.month) return r.month === month;
                    if (r.createdAt) return r.createdAt.startsWith(month);
                    return false;
                });

                const validationErrors = validateInvoiceData(employee, salaryData, completedTasks, monthDeductions, employeeResponsibilities);
                if (validationErrors.length > 0) throw new Error('أخطاء في التحقق من البيانات: ' + validationErrors.join(', '));

                populateInvoice(employee, salaryData, completedTasks, monthDeductions, employeeResponsibilities);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('invoice').style.display = 'block';
            } catch (error) {
                console.error('Error loading invoice:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'فشل تحميل الفاتورة: ' + error.message;
            }
        }

        function populateInvoice(employee, salaryData, tasks, deductions, responsibilities) {
            // Employee info
            document.getElementById('employee-name').textContent = employee.name || '-';
            document.getElementById('employee-id').textContent = employee.id || '-';
            document.getElementById('invoice-date').textContent = formatArabicDate();

            // Hours
            const attendance = salaryData.attendance || {};
            const totalHours = Math.round(attendance.totalHours || 0);
            const overtimeHours = Math.round(attendance.overtimeHours || 0);
            const regularHours = totalHours - overtimeHours;

            document.getElementById('regular-hours').textContent = regularHours + ' ساعة';
            document.getElementById('overtime-hours').textContent = overtimeHours + ' ساعة';
            document.getElementById('total-hours').textContent = totalHours + ' ساعة';

            // Tasks COUNT only (not list)
            const tasksList = document.getElementById('tasks-list');
            if (tasks && tasks.length > 0) {
                tasksList.innerHTML = `
                    <div class="data-row">
                        <span class="data-label">${tasks.length} مهمة</span>
                    </div>
                `;
            } else {
                tasksList.innerHTML = '<div class="data-row"><span class="data-label">لا توجد مهام</span></div>';
            }

            // Responsibilities COUNT only (not list)
            const responsibilitiesList = document.getElementById('responsibilities-list');
            if (responsibilities && responsibilities.length > 0) {
                responsibilitiesList.innerHTML = `
                    <div class="data-row">
                        <span class="data-label">${responsibilities.length} مسؤولية</span>
                    </div>
                `;
            } else {
                responsibilitiesList.innerHTML = '<div class="data-row"><span class="data-label">لا توجد مسؤوليات</span></div>';
            }

            // Deductions - Show reasons/names only (not amounts)
            const deductionsList = document.getElementById('deductions-list');
            if (deductions && deductions.length > 0) {
                const deductionsHTML = deductions.map(d => `
                    <div class="data-row">
                        <span class="data-label">${d.reason || d.name || 'خصم'}</span>
                    </div>
                `).join('');
                deductionsList.innerHTML = deductionsHTML;
            } else {
                deductionsList.innerHTML = '<div class="data-row"><span class="data-label">لا توجد خصومات</span></div>';
            }

            // Display ONLY net salary
            const netSalary = salaryData.netSalary || 0;
            document.getElementById('net-salary').textContent = formatCurrency(netSalary);
        }

        loadInvoiceData();
    </script>
</body>

</html>